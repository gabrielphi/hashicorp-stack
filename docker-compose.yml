services:
  ansible:
    build:
      context: ./ansible
      dockerfile: Dockerfile
    working_dir: /workspace/ansible
    volumes:
      - ./ansible:/workspace/ansible
      # ============================================
      # CONFIGURAÇÃO DA CHAVE SSH
      # ============================================
      # Altere "magalu" abaixo para o nome da sua chave SSH em ~/.ssh/
      # A chave será montada como /root/.ssh/id_ed25519 dentro do container
      # Sem :ro para permitir ajuste de permissões dentro do container
      - ~/.ssh/magalu:/root/.ssh/id_ed25519
    environment:
      # Caminho da chave dentro do container (sempre id_ed25519)
      - ANSIBLE_PRIVATE_KEY_FILE=/root/.ssh/id_ed25519
      # Forçar uso do ansible.cfg em /etc/ansible/
      - ANSIBLE_CONFIG=/etc/ansible/ansible.cfg
      # Variáveis adicionais para garantir uso direto da chave
      - ANSIBLE_HOST_KEY_CHECKING=False
      - ANSIBLE_SSH_ARGS=-o IdentitiesOnly=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
    # Exemplo de comando padrão rodando o playbook
    command: ["ansible-playbook", "-i", "inventory.ini", "site.yml"]

  mysql:
    image: mysql:8.0
    container_name: mysql-app-teste
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: testdb
      MYSQL_USER: testuser
      MYSQL_PASSWORD: testpassword
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-prootpassword"]
      interval: 10s
      timeout: 5s
      retries: 5

  app-teste:
    build:
      context: ./app-teste
      dockerfile: Dockerfile
    container_name: app-teste
    ports:
      - "5000:5000"
    environment:
      DB_HOST: mysql
      DB_USER: root
      DB_PASSWORD: rootpassword
      DB_NAME: testdb
      DB_PORT: 3306
    depends_on:
      mysql:
        condition: service_healthy
    restart: unless-stopped

volumes:
  mysql_data:

